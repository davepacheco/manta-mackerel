#!/bin/bash -x
# Copyright (c) 2013, Joyent, Inc. All rights reserved.

set -o pipefail

dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

bunyan -j --strict -c \
        "this.audit == true &&
        this.req.url !== '/ping' &&
        this.req.owner" \
| json -ga req.owner req.method resHeaderLength reqHeaderLength res.statusCode \
        req.headers.content-length res.headers.content-length \
| awk '{
        owner = $1;
        method = $2;
        resHeaderLength = $3;
        reqHeaderLength = $4;
        statusCode = $5;
        contentLength = $6;

        owners[owner] = owner;

        headerBWOut[owner] += resHeaderLength;
        headerBWIn[owner] += reqHeaderLength;

        if (method == "OPTIONS") {
                options[owner] += 1;
        }
        if (method == "GET") {
                gets[owner] += 1;
                if (contentLength && statusCode >= 200 && statusCode <= 204) {
                        bwout[owner] += contentLength;
                }
        }
        if (method == "HEAD") {
                heads[owner] += 1;
        }
        if (method == "POST") {
                posts[owner] += 1;
        }
        if (method == "PUT") {
                puts[owner] += 1;
                if (contentLength && statusCode >= 200 && statusCode <= 204) {
                        bwin[owner] += contentLength;
                }
        }
        if (method == "DELETE") {
                deletes[owner] += 1;
        }
        if (method == "TRACE") {
                traces[owner] += 1;
        }
        if (method == "CONNECT") {
                connects[owner] += 1;
        }
} END {
        for (o in owners) {
                options[o] = options[o] == "" ? 0 : options[o];
                gets[o] = gets[o] == "" ? 0 : gets[o];
                heads[o] = heads[o] == "" ? 0 : heads[o];
                posts[o] = posts[o] == "" ? 0 : posts[o];
                puts[o] = puts[o] == "" ? 0 : puts[o];
                deletes[o] = deletes[o] == "" ? 0 : deletes[o];
                traces[o] = traces[o] == "" ? 0 : traces[o];
                connects[o] = connects[o] == "" ? 0 : connects[o];
                bwin[o] = bwin[o] == "" ? 0 : bwin[o];
                bwout[o] = bwout[o] == "" ? 0 : bwout[o];
                headerBWIn[o] = headerBWIn[o] == "" ? 0 : headerBWIn[o];
                headerBWOut[o] = headerBWOut[o] == "" ? 0 : headerBWOut[o];

                total = gets[o] + heads[o] + posts[o] + puts[o] + deletes[o] + \
                        traces[o] + connects[o];

                print o, total, options[o], gets[o], heads[o], posts[o],
                        puts[o], deletes[o], traces[o], connects[o],
                        bwin[o], bwout[o], headerBWIn[o], headerBWOut[o];
        }
}' \
| msplit -n $NUM_REDUCERS -d " " -f 1
